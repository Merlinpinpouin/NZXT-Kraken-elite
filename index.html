<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deezer Now Playing</title>
</head>
<body>
    <h1>Deezer Now Playing</h1>
    <button id="connect">Se connecter à Deezer</button>
    <div id="nowPlaying" style="display: none;">
        <h2>Musique en cours :</h2>
        <p id="trackName">Titre : </p>
        <p id="artistName">Artiste : </p>
        <p id="albumName">Album : </p>
        <img id="albumCover" src="" alt="Album Cover" style="width: 200px;">
    </div>

    <script>
        const appId = '628564';
        const redirectUri = 'https://merlinpinpouin.github.io/NZXT-Kraken-elite/index.html'; // Assure-toi que cela correspond à ce que tu as configuré dans Deezer

        document.getElementById('connect').addEventListener('click', () => {
            // Redirection vers la page de connexion Deezer
            window.location.href = `https://connect.deezer.com/oauth/auth.php?app_id=${appId}&redirect_uri=${encodeURIComponent(redirectUri)}&perms=basic_access,listening_history`;
        });

        // Fonction pour vérifier le token d'accès
        function handleToken() {
            const urlParams = new URLSearchParams(window.location.hash.substr(1));
            const accessToken = urlParams.get('access_token');

            if (accessToken) {
                // Stocker le token dans localStorage
                localStorage.setItem('deezer_access_token', accessToken);
                // Nettoyer l'URL en retirant le fragment
                window.location.hash = '';
                // Afficher les informations de la musique en cours
                displayNowPlaying(accessToken);
            } else {
                // Vérifier si le token est déjà stocké
                const storedToken = localStorage.getItem('deezer_access_token');
                if (storedToken) {
                    displayNowPlaying(storedToken);
                } else {
                    // Afficher le bouton de connexion si aucun token n'est trouvé
                    document.getElementById('connect').style.display = 'block';
                }
            }
        }

        // Fonction pour afficher les informations de la musique en cours
        function displayNowPlaying(accessToken) {
            document.getElementById('connect').style.display = 'none';
            fetch('https://api.deezer.com/user/me/player?access_token=' + accessToken)
                .then(response => response.json())
                .then(data => {
                    if (data && data.track) {
                        document.getElementById('nowPlaying').style.display = 'block';
                        document.getElementById('trackName').textContent = 'Titre : ' + data.track.title;
                        document.getElementById('artistName').textContent = 'Artiste : ' + data.track.artist.name;
                        document.getElementById('albumName').textContent = 'Album : ' + data.track.album.title;
                        document.getElementById('albumCover').src = data.track.album.cover_medium;
                    } else {
                        console.error('Erreur : Les données de musique ne sont pas disponibles.');
                    }
                })
                .catch(error => console.error('Erreur lors de la récupération des données :', error));
        }

        // Appel de la fonction pour vérifier le token lorsque la page se charge
        handleToken();
    </script>
</body>
</html>
